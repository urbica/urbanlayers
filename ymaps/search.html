<!DOCTYPE html>
<meta charset="utf-8">
<script src="turf.min.js" charset="utf-8"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://yandex.st/jquery/2.1.1/jquery.min.js" type="text/javascript"></script>
<script src="http://api-maps.yandex.ru/2.1/?lang=ru_RU&coordorder=longlat"></script>

<!-- <script src="jsonp.js"></script> -->


<style>


  * {
    font-family: sans-serif;
  }
  #searchBar {
    position: absolute;
    z-index: 1909090;
    top: 10px;
    left: 50px;
    background: #fff;
    padding: 10px;
  }

  html, body {
    font-family: sans-serif, arial;
    width: 100%;
    height: 100%;
    margin: 0;
  }

  #map {
    display: block;
    width: 100%;
    height: 100%;
    min-height: 450px;
    margin: 0;
  }

  #pageContainer {
    display: block;
    flex-direction: column;
  }

  #mapContainer {

    width: 100%;
    height: 100%;
    min-height: 400px;
    background: #f0f0f0;
  }

  #panelContainer {
    display: block;
    height: 200px;
    padding: 20px;
  }

  #hoursStats, #distancesStats {
    display: inline-block;


  }

  .dayLabel {
    font-family: sans-serif;
    font-size: 14px;
  }

  .tooltip {
    position: absolute;
    text-align: center;
    /* width: 60px;
    height: 28px; */
    padding: 5px;
    font: 12px sans-serif;
    background: #dedede;
    border: 0px;
    border-radius: 2px;
    pointer-events: none;
  }

  .axis text {
    font: 10px sans-serif;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }


</style>
<body>
<div id='searchBar'><input type='text' value='ресторан' id='searchInput'><button id='searchBtn'>Поиск</button></div>

<div id='pageContainer'>
<div id='mapContainer'>
  <div id='map'></div>
</div>
<div id='panelContainer'>
  <div id='distancesStats'></div>
  <div id='hoursStats'></div>
  <div id='daysStats'></div>
</div>
</div>

<!--
https://search-maps.yandex.ru/v1/?apikey=6a6d6520-a9d5-4d64-889e-de25e17bbe9d&text=аптеки&lang=ru_RU
 & [ll=<центр области поиска>]
 & [spn=<размеры области поиска>]
 & [rspn=<не искать за пределами области поиска>]
 & [type=<типы объектов>]
 & [results=<количество результатов>]
 & [skip=<количество пропускаемых результатов>]
 & [callback=<имя функции>]
-->
<script>



ymaps.ready(function() {


var x = d3.scale.linear()
    .domain([0,23])
    .range([0,480]);

var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");



var hoursDiv = d3.select("#hoursStats");
var distancesDiv = d3.select("#distancesStats")
var hoursChart = hoursDiv.append("svg").attr("width", 800).attr("height", 200);

// Define the div for the tooltip
var tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);


//var start = [37.771247, 55.726543]; //восход
var start = [37.500531,55.820162]; //варшава

var params = {
  apikey: '6a6d6520-a9d5-4d64-889e-de25e17bbe9d',
  text: 'ресторан',
  lang: 'ru_RU',
  ll: '37.500531,55.820162',
  spn: '0.05,0.05',
  results: 200,
  callback: 'processData'
};

var zonesColors = {
  '5': '#253494',
  '10': '#2c7fb8',
  '15': '#41b6c4',
  '20': '#7fcdbb',
  '30': '#c7e9b4',
  '35': '#ffffcc',
  '60': '#ffffcc'
}

var days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

var jsonData, filteredData, zonesJson, filteredFeatures = []; //global source data

function getURL(params) {
  var url = 'https://search-maps.yandex.ru/v1/?';

  Object.keys(params).forEach(function(k) {
    url += '&' + k + '=' + params[k];
  });
  return url;
}


	//создаём карту с центром в Москве, на 11 масштабе с дефолтным набором элементов управления
	var map = new ymaps.Map('map', {
		center: start,
		zoom: 15,
		controls: ['typeSelector']
	});


  zones = new ymaps.GeoObjectCollection(null, {	});
  map.geoObjects.add(zones);


  var companyInfoTemplate = ymaps.templateLayoutFactory.createClass(
           '<h3>{{ properties.name|default:"Заголовок" }}</h3>' +
           '~ {{ properties.time_min|default:"??" }} – {{ properties.time_max|default:"??" }} минут пешком' +
           ' '
  );

  clusterer = new ymaps.Clusterer({
            preset: 'islands#blackClusterIcons',
            groupByCoordinates: true,
            clusterDisableClickZoom: true,
            clusterHideIconOnBalloonOpen: false,
            geoObjectHideIconOnBalloonOpen: false
        });
  map.geoObjects.add(clusterer);



	//создаём геоколлекцию, с заданными параметрами значка метки
	collection = new ymaps.GeoObjectCollection(null, {
  	 preset: 'islands#circleDotIcon',
     iconColor: '#555',
     balloonContentLayout: companyInfoTemplate
   }, {

   });

   collection.events.add('click', function (e) {
    var object = e.get('target');
    console.log(object);
  });

  map.geoObjects.add(collection);

  jQuery.getJSON('data/varshava_isolines_single.geojson', function(json) {
  //добавляем геообъекты в коллекцию
  //console.log(json);

  //store zones into global
  zonesJson = json;

  json.features.forEach(function(feature) {

  if(feature.properties['time_max']<=35) {

    var opacity = 1 - feature.properties['time_max']/35;
    //console.log(opacity);
    var polygon = new ymaps.Polygon(feature.geometry.coordinates[0], {
    hintContent: feature.properties['time_max'],
    balloonContent: feature.properties['time_max']
    }, {
    fillColor: zonesColors[feature.properties['time_max']],
    // Делаем полигон прозрачным для событий карты.
    interactivityModel: 'default#transparent',
    strokeOpacity: 0.5,
    strokeColor: '#555',
    strokeWidth: 0.5,
    opacity: opacity
    });
    map.geoObjects.add(polygon);

  }

  });



  //temporary
  //requestData();

  });


  var searchInput = d3.select("#searchInput");
  var searchBtn = d3.select("#searchBtn").on('click', function() {
    params.text = searchInput.property("value");
    requestData();
    });

    function requestData() {
    // Using YQL and JSONP
    $.ajax({
      url: "https://search-maps.yandex.ru/v1/?",
      // The name of the callback parameter, as specified by the YQL service
      jsonp: "callback",
      dataType: "jsonp",
      data: params,

      // Work with the response
      success: function(response) {
          jsonData = response.data;

          //adding CompanyMetaData to the features
          jsonData.features.forEach(function(feature,i) {
            jQuery.extend(feature.properties, feature.properties.CompanyMetaData);
          });

          jsonData = turf.tag(jsonData, zonesJson, 'time_max', 'time_max');

          drawData(); // server response
      }
    });

    }

  function drawData() {

    //remove all objects in the collection
    clusterer.removeAll();

    filteredData = jsonData;

    var filteredFeatures = filteredData.features.filter(function (feature) {
      return feature.properties['time_max'] <= 35;
    });

    //setting filtered features
    filteredData.features = filteredFeatures;

    var hoursStats = [];
    days.forEach(function(d) {
      hoursStats[d] = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; //Dummy hours
    });

    var distanceStats = [];
    var hoursCalculated = 0;

    var fr,to, total = filteredFeatures.length;



    filteredFeatures.forEach(function(feature) {

      //calculate days array
      if(feature.properties.Hours) {
        hoursCalculated ++;

        feature.properties.Hours.Availabilities.forEach(function(a) {
          console.log(a);
          if(a['Everyday']) {
            if(a['TwentyFourHours']) {
              //console.log('24/7');
              days.forEach(function(d) {
                for(h=0; h<24; h++) {
                  hoursStats[d][h]++;
                }
              });
            } else {
              if(a.Intervals) {
                a.Intervals.forEach(function(inrvl) {
                  fr = +inrvl.from.substr(0,2);
                  to = +inrvl.to.substr(0,2);
                  if(to == 0) { to = 24; }
                  //console.log('fr: ' + fr + ' to: ' + to);
                  days.forEach(function(d) {
                    for(h=fr; h<to; h++) { hoursStats[d][h]++; }
                  });
                });
              }
            }
          } else {
            days.forEach(function(d) {
              if(a[d]) {
                a.Intervals.forEach(function(inrvl) {
                  fr = +inrvl.from.substr(0,2);
                  to = +inrvl.to.substr(0,2);
                  if(to == 0) { to = 24; }
                  //console.log('fr: ' + fr + ' to: ' + to);
                    for(h=fr; h<to; h++) { hoursStats[d][h]++; }
                });
              }
            });
          }

        });

      }

      if(!distanceStats[feature.properties['time_max']]) {
        distanceStats[feature.properties['time_max']] = 1;
      } else {
        distanceStats[feature.properties['time_max']]++;
      }


      //add feature to the map
      //console.log(feature.properties);
      var placemark = new ymaps.Placemark(feature.geometry.coordinates, {
        name: feature.properties['name'],
        balloonContentHeader: feature.properties['name'],
        balloonContent: getBallonContent(feature.properties),
        time_max: feature.properties['time_max'],
        time_min: (feature.properties['time_max']-5)
      }, {
      // Задаем стиль метки (метка в виде круга).
      preset: "islands#dotCircleIcon",
      // Задаем цвет метки (в формате RGB).
      iconColor: zonesColors[feature.properties['time_max']]
      });
      clusterer.add(placemark);
    });

    //stats debug output
    console.log('all: ' + filteredFeatures.length + ' with hours: ' + hoursCalculated);
    console.log('distances: ' + distanceStats);
    console.log(hoursStats);

    drawHours(hoursStats,hoursCalculated);
    drawDistances(distanceStats,filteredFeatures.length);

    //tagging objects inside
    //ymaps.geoQuery(filteredData).addTo(collection);

  }

  function getBallonContent(props) {
    var s = '';

    if(props.Categories) {
    s += '<div class="categories">';
    props.Categories.forEach(function (c) {
      s += '<span>' + c.name + '</span>';
    });
    s += '</div>';
    }
    s += '<div class="distances">~' + + props['time_max'] + ' мин.</div>';
    return s;
  }

  function drawHours(hoursStats,total) {
    hoursChart.text("");

    hoursChart.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(80,140)")
        .call(xAxis);

    var daysAxis = hoursChart.append("g");
    var blocks = hoursChart.append("g").attr("transform", "translate(80,0)");

    days.forEach(function(day,id) {

      daysAxis.append("text")
        .attr("x", 10 )
        .attr("y", (id*20+16))
        .attr("class", "dayLabel")
        .text(day);


      hoursStats[day].forEach(function(hourStat, ih) {
      //  console.log(day + ': ' + ih + ' — ' + hourStat);
        blocks
          .append("rect")
          .attr("width", 19)
          .attr("height", 19)
          .attr("transform", function(d, i) { return "translate(" + (ih*20) + "," + (id*20) + ")"; })
          .style("opacity", hourStat/total)
          .style("fill", "#009090")
          .on("mouseover", function(d) {
            tooltip
              .style("opacity", .9)
              .text(day + ' ' + ih + ':00  ' +  hourStat + '/' + total)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 28) + "px");
            })
          .on("mouseout", function(d) {
            tooltip.style("opacity", 0);
          });
      });
    });
  }

 function drawDistances(distances, total) {
   var html = 'Общее число: ' + total + '&nbsp;&nbsp;&nbsp;&nbsp;';
   //html += '<br/> ' + ''
   for(dist in distances) {
     html += dist + '&nbsp;мин: ' + distances[dist] + "&nbsp;&nbsp;";
//     console.log('dist: ' + dist + ': ' + distances[dist]);
   }
   distancesDiv.html(html);
 }


});

</script>
